#!/usr/bin/env ruby
APP_PATH = File.expand_path('../../config/application',  __dir__)
require_relative '../config/boot'
require_relative '../config/environment'
require 'open-uri'

source_html = Rails.root.join("data", "teams.html")
output_json = Rails.root.join("data", "teams.json")

TEAMS_URL = "https://www.easports.com/fifa/news/2016/fifa-17-leagues-and-teams"

if !File.exists? source_html
  open(source_html, 'wb') do |file|
    file << open(TEAMS_URL).read
  end
end

doc = File.open(source_html) { |f| Nokogiri::HTML(f) }
league_nodes = doc.css(".article-detail .eas-b2 h3")


result = {}

league_nodes.each do |league_node|
  league = league_node.text
  teams = league_node.next_element.css("p").map(&:text).map(&:strip).select { |s| !s.blank? }

  result[league] = teams
end


open(output_json, 'wb') do |file|
  file << result.to_json
end
